name: Deploy Invitation Frontend to S3

on:
  push:
    branches:
      - main
    paths:
      - 'invitation/site/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      PROD_API_ENDPOINT: ${{ secrets.PROD_API_ENDPOINT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          missing=()
          for v in AWS_REGION S3_BUCKET_NAME PROD_API_ENDPOINT; do
            if [ -z "${!v}" ]; then missing+=("$v"); fi
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing required secrets: ${missing[*]}" >&2
            exit 1
          fi

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Generate runtime config.json
        run: |
          jq --arg ep "$PROD_API_ENDPOINT" '.apiEndpoint = $ep' invitation/site/config.sample.json > invitation/site/config.json
          echo "Generated config.json:" && cat invitation/site/config.json

      - name: Sync static site to S3 (under /invitation/ prefix)
        run: |
          aws s3 sync invitation/site "s3://$S3_BUCKET_NAME/invitation" \
            --delete \
            --exclude "*.py" \
            --exclude "*.psd" \
            --exclude "*.ai" \
            --exclude "*.xcf" \
            --cache-control max-age=300

      - name: Invalidate CloudFront
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
            --paths "/*"

      - name: Deployment Summary
        run: |
          echo "âœ… Invitation frontend deployment complete"
          echo "S3 Bucket: $S3_BUCKET_NAME/invitation"
          echo "API Endpoint: $PROD_API_ENDPOINT"
